<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Juegos</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        header {
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }
        header h1:hover {
            color: #ccc;
        }
        .controls {
            position: sticky;
            top: 20px;
            background: #000;
            z-index: 1000;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        .profile-selector {
            margin-bottom: 10px;
        }
        .profile-selector button {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        .profile-selector button.active {
            background: #444;
        }
        .profile-selector .must-play-button {
            background: #C3B1E1; /* Púrpura suave */
            color: #000;
        }
        .search-bar {
            margin-bottom: 10px;
            text-align: center;
        }
        .search-bar input {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 5px;
            margin: 0 10px;
            border-radius: 5px;
        }
        .filters {
            margin-bottom: 10px;
            text-align: center;
        }
        .filters select {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 5px;
            margin: 0 10px;
            border-radius: 5px;
        }
        .games-grid, .main-games-grid, .must-play-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .game-card, .main-game-card, .must-play-card {
            background: #222;
            border-radius: 10px;
            padding: 10px;
            margin: 10px;
            width: 200px;
            display: inline-block;
            vertical-align: top;
            position: relative;
        }
        .game-card img, .main-game-card img, .must-play-card img {
            width: 100%;
            border-radius: 5px;
        }
        .game-card button {
            background: #600;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
        }
        .game-card .edit-btn { background: #060; }
        .main-game-card button, .must-play-card button { display: none; }
        h3 { margin: 10px 0 5px 0; }
        p { margin: 5px 0; font-size: 0.9em; }
        .add-form, .edit-form, .must-play-form {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }
        .add-form.active, .edit-form.active, .must-play-form.active {
            display: block;
        }
        .add-form input, .add-form select, .edit-form input, .edit-form select, .must-play-form input, .must-play-form select {
            background: #333;
            color: #fff;
            border: 1px solid #444;
            padding: 5px;
            margin: 5px 0;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        .add-form button, .edit-form button, .must-play-form button {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .sync-button, .auth-button, .debug-toggle, .load-more, .load-all, .retro-button {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .auth-button { background: #4CAF50; }
        #debug {
            margin-top: 20px;
            color: #ff0;
            display: none;
        }
        .debug-active #debug {
            display: block;
        }
        .must-play-controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .must-play-controls select {
            background: #222;
            color: #fff;
            border: 1px solid #444;
            padding: 5px;
            margin: 0 10px;
            border-radius: 5px;
        }
        .audio-controls {
            text-align: center;
            margin-top: 20px;
        }
        audio {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header onclick="loadProfile('main')">
        <h1>Mis Puntajes de Videojuegos</h1>
    </header>

    <div class="controls">
        <div class="profile-selector">
            <button onclick="loadProfile('z4')">Z4</button>
            <button onclick="loadProfile('shenqi')">Shenqi</button>
            <button onclick="loadProfile('cayden')">Cayden</button>
            <button onclick="toggleForm('add')">Agregar Juego</button>
            <button class="must-play-button" onclick="loadMustPlay()">Lista Cronológica Must Play</button>
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar por título..." onkeyup="applySearch()">
        </div>
        <div class="filters">
            <label>Año:</label>
            <select id="filterYear" onchange="applyFiltersAndSearch()">
                <option value="">Todos</option>
            </select>
            <label>Plataforma:</label>
            <select id="filterPlatform" onchange="applyFiltersAndSearch()">
                <option value="">Todos</option>
            </select>
        </div>
        <form id="addForm" class="add-form">
            <h3>Agregar Nuevo Juego</h3>
            <input type="text" id="gameTitle" placeholder="Título" required>
            <input type="number" id="gameYear" placeholder="Año" min="1900" max="2025" required>
            <select id="gamePlatform" required>
                <option value="">Selecciona Plataforma</option>
                <option value="PC">PC</option>
                <option value="Wii">Wii</option>
                <option value="Switch">Switch</option>
                <option value="PS3">PS3</option>
                <option value="PS4">PS4</option>
                <option value="PS5">PS5</option>
                <option value="Xbox">Xbox</option>
                <option value="Xbox 360">Xbox 360</option>
                <option value="Xbox One">Xbox One</option>
                <option value="Xbox Series X">Xbox Series X</option>
                <option value="GameCube">GameCube</option>
                <option value="NES">NES</option>
                <option value="SNES">SNES</option>
                <option value="N64">N64</option>
                <option value="Game Boy">Game Boy</option>
                <option value="DS">DS</option>
                <option value="3DS">3DS</option>
                <option value="PSP">PSP</option>
                <option value="Vita">Vita</option>
            </select>
            <input type="number" id="gamePuntaje" placeholder="Puntaje" step="0.01" min="0" max="100" required>
            <input type="text" id="gameImage" placeholder="URL de Imagen (ej. https://ejemplo.com/imagen.jpg)" required>
            <button type="button" onclick="addGame()">Guardar</button>
            <button type="button" onclick="toggleForm('add')">Cancelar</button>
        </form>
    </div>
    <a href="https://vimm.net/?p=vault" target="_blank" class="retro-button">No sabes donde descargar juegos retro?</a>

    <div id="mainGamesContainer" class="main-games-grid"></div>
    <div id="loadMoreMain" class="load-more" onclick="loadMoreMainGames()">Cargar más</div>
    <div id="loadAllMain" class="load-all" onclick="loadAllMainGames()">Cargar todo</div>
    <div id="gamesContainer" class="games-grid"></div>

    <form id="editForm" class="edit-form">
        <h3>Editar Juego</h3>
        <input type="text" id="editGameTitle" placeholder="Título" required>
        <input type="number" id="editGameYear" placeholder="Año" min="1900" max="2025" required>
        <select id="editGamePlatform" required>
            <option value="">Selecciona Plataforma</option>
            <option value="PC">PC</option>
            <option value="Wii">Wii</option>
            <option value="Switch">Switch</option>
            <option value="PS3">PS3</option>
            <option value="PS4">PS4</option>
            <option value="PS5">PS5</option>
            <option value="Xbox">Xbox</option>
            <option value="Xbox 360">Xbox 360</option>
            <option value="Xbox One">Xbox One</option>
            <option value="Xbox Series X">Xbox Series X</option>
            <option value="GameCube">GameCube</option>
            <option value="NES">NES</option>
            <option value="SNES">SNES</option>
            <option value="N64">N64</option>
            <option value="Game Boy">Game Boy</option>
            <option value="DS">DS</option>
            <option value="3DS">3DS</option>
            <option value="PSP">PSP</option>
            <option value="Vita">Vita</option>
        </select>
        <input type="number" id="editGamePuntaje" placeholder="Puntaje" step="0.01" min="0" max="100" required>
        <input type="text" id="editGameImage" placeholder="URL de Imagen (ej. https://ejemplo.com/imagen.jpg)" required>
        <button type="button" onclick="saveEdit()">Guardar</button>
        <button type="button" onclick="toggleForm('edit')">Cancelar</button>
    </form>

    <button class="sync-button" onclick="syncToClipboard()">Copiar Cambios al Portapapeles</button>

    <div id="mustPlayContainer" class="must-play-grid" style="display:none;">
        <div class="must-play-controls">
            <label>Orden:</label>
            <select id="sortOrder" onchange="applyMustPlayFilters()">
                <option value="asc">Más antiguo al más nuevo</option>
                <option value="desc">Más nuevo al más antiguo</option>
            </select>
        </div>
        <button class="sync-button" onclick="tryYourLuck()">Proba tu suerte</button>
        <div id="loadMoreMustPlay" class="load-more" onclick="loadMoreMustPlayGames()">Cargar más</div>
        <div id="loadAllMustPlay" class="load-all" onclick="loadAllMustPlayGames()">Cargar todo</div>
    </div>

    <form id="mustPlayForm" class="must-play-form">
        <h3>Agregar Juego Must Play</h3>
        <input type="text" id="mustPlayTitle" placeholder="Título" required>
        <input type="number" id="mustPlayYear" placeholder="Año" min="1900" max="2025" required>
        <input type="text" id="mustPlayDeveloper" placeholder="Desarrolladora" required>
        <select id="mustPlayPlatform" required>
            <option value="">Selecciona Plataforma</option>
            <option value="PC">PC</option>
            <option value="Wii">Wii</option>
            <option value="Switch">Switch</option>
            <option value="PS3">PS3</option>
            <option value="PS4">PS4</option>
            <option value="PS5">PS5</option>
            <option value="Xbox">Xbox</option>
            <option value="Xbox 360">Xbox 360</option>
            <option value="Xbox One">Xbox One</option>
            <option value="Xbox Series X">Xbox Series X</option>
            <option value="GameCube">GameCube</option>
            <option value="NES">NES</option>
            <option value="SNES">SNES</option>
            <option value="N64">N64</option>
            <option value="Game Boy">Game Boy</option>
            <option value="DS">DS</option>
            <option value="3DS">3DS</option>
            <option value="PSP">PSP</option>
            <option value="Vita">Vita</option>
        </select>
        <input type="text" id="mustPlayImage" placeholder="URL de Imagen (ej. https://ejemplo.com/imagen.jpg)" required>
        <button type="button" onclick="addMustPlayGame()">Guardar</button>
        <button type="button" onclick="toggleForm('must-play')">Cancelar</button>
    </form>

    <div class="audio-controls">
        <button class="sync-button" onclick="playAudio()">Reproducir Música</button>
        <audio id="audioPlayer" controls>
            <source src="https://elfodenazaretz4.github.io/mis-puntajes-juegos/audio/SIM-Nights.mp3" type="audio/mp3">
            Tu navegador no soporta el elemento de audio.
        </audio>
    </div>

    <button class="debug-toggle" onclick="toggleDebug()">Mostrar Depuración</button>
    <div id="debug"></div>

    <script>
        let data = {};
        let currentProfile = 'main';
        let allGames = [];
        let editIndex = -1;
        let debugEnabled = false;
        let mustPlayData = [];
        let mainGamesOffset = 0;
        let mustPlayOffset = 0;
        const PAGE_SIZE = 21;
        let renderedMainGames = [];
        let renderedMustPlayGames = [];

        // Configuración de Google Sheets
        const API_KEY = 'AIzaSyCN2mcDPn_rq4YQU2t5aQFFLhAhQGoYc9E'; // Tu clave API
        const SPREADSHEET_ID = '1gauIcXDfqgYTGHGSTojlULZc6LPTQMTRpX-9Lqfm8pg'; // Tu ID de hoja

        // Cargar datos desde Google Sheets
        function loadData() {
            const debugDiv = document.getElementById('debug');
            if (debugEnabled) debugDiv.innerHTML = 'Cargando datos...';
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/A:F?key=${API_KEY}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(dataResponse => {
                    const rows = dataResponse.values;
                    if (debugEnabled) debugDiv.innerHTML += '<br>Respuesta recibida: ' + JSON.stringify(rows);
                    if (rows && rows.length > 1) {
                        data = { z4: [], shenqi: [], cayden: [] };
                        for (let i = 1; i < rows.length; i++) {
                            const [perfil, titulo, año, plataforma, puntaje, img] = rows[i] || [];
                            if (perfil && titulo && año && plataforma && puntaje && img) {
                                data[perfil.toLowerCase()].push({
                                    titulo: titulo,
                                    año: parseInt(año),
                                    plataforma: plataforma,
                                    puntaje: parseFloat(puntaje),
                                    img: img
                                });
                                if (debugEnabled) debugDiv.innerHTML += `<br>Fila ${i + 1} procesada: ${perfil}, ${titulo}, ${año}, ${plataforma}, ${puntaje}, ${img}`;
                            }
                        }
                        if (debugEnabled) debugDiv.innerHTML += `<br>Datos cargados: ${rows.length - 1} filas procesadas.`;
                        updateDisplay();
                    } else {
                        if (debugEnabled) debugDiv.innerHTML += '<br>No se encontraron datos válidos en la hoja.';
                    }
                })
                .catch(error => {
                    if (debugEnabled) debugDiv.innerHTML = `Error al cargar datos: ${error.message}`;
                    console.error('Error details:', error);
                    const savedData = localStorage.getItem('gameData');
                    if (savedData) {
                        data = JSON.parse(savedData);
                        updateDisplay();
                    }
                });
        }

        // Cargar datos Must Play desde Google Sheets
        function loadMustPlayData() {
            const debugDiv = document.getElementById('debug');
            if (debugEnabled) debugDiv.innerHTML += '<br>Cargando datos Must Play...';
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/G:K?key=${API_KEY}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(dataResponse => {
                    const rows = dataResponse.values;
                    if (debugEnabled) debugDiv.innerHTML += '<br>Respuesta Must Play recibida: ' + JSON.stringify(rows);
                    if (rows && rows.length > 1) {
                        mustPlayData = [];
                        for (let i = 1; i < rows.length; i++) {
                            const [titulo, año, desarrolladora, plataforma, img] = rows[i] || [];
                            if (titulo && año && desarrolladora && plataforma && img) {
                                mustPlayData.push({
                                    titulo: titulo,
                                    año: parseInt(año),
                                    desarrolladora: desarrolladora,
                                    plataforma: plataforma,
                                    img: img
                                });
                                if (debugEnabled) debugDiv.innerHTML += `<br>Fila Must Play ${i + 1} procesada: ${titulo}, ${año}, ${desarrolladora}, ${plataforma}, ${img}`;
                            }
                        }
                        if (debugEnabled) debugDiv.innerHTML += `<br>Datos Must Play cargados: ${rows.length - 1} filas procesadas.`;
                        applyMustPlayFilters();
                    } else {
                        if (debugEnabled) debugDiv.innerHTML += '<br>No se encontraron datos válidos en Must Play.';
                    }
                })
                .catch(error => {
                    if (debugEnabled) debugDiv.innerHTML = `Error al cargar datos Must Play: ${error.message}`;
                    console.error('Error details:', error);
                });
        }

        // Actualizar pantalla
        function updateDisplay() {
            if (currentProfile !== 'main') {
                allGames = data[currentProfile] || [];
                updateFilters();
                applyFiltersAndSearch();
            } else {
                renderMainGames();
            }
        }

        // Cargar perfil
        window.onload = function() {
            loadData();
            loadProfile('main');
        };

        function loadProfile(profile) {
            currentProfile = profile;
            if (profile === 'main') {
                document.getElementById('gamesContainer').style.display = 'none';
                document.getElementById('mainGamesContainer').style.display = 'flex';
                mainGamesOffset = 0;
                renderedMainGames = [];
                renderMainGames();
                updateFiltersForMain();
            } else {
                document.getElementById('mainGamesContainer').style.display = 'none';
                document.getElementById('gamesContainer').style.display = 'flex';
                allGames = data[profile] || [];
                updateFilters();
                applyFiltersAndSearch();
            }
            const buttons = document.querySelectorAll('.profile-selector button');
            buttons.forEach(btn => btn.classList.remove('active'));
            const activeButton = document.querySelector(`.profile-selector button[onclick="loadProfile('${profile}')"]`);
            if (activeButton) activeButton.classList.add('active');
        }

        function updateFilters() {
            const years = allGames.length > 0 ? [...new Set(allGames.map(g => g.año))].sort((a, b) => b - a) : [];
            const platforms = allGames.length > 0 ? [...new Set(allGames.map(g => g.plataforma))].sort() : [];
            const yearSelect = document.getElementById('filterYear');
            yearSelect.innerHTML = '<option value="">Todos</option>' + (years.length > 0 ? years.map(y => `<option value="${y}">${y}</option>`).join('') : '');
            const platformSelect = document.getElementById('filterPlatform');
            platformSelect.innerHTML = '<option value="">Todos</option>' + (platforms.length > 0 ? platforms.map(p => `<option value="${p}">${p}</option>`).join('') : '');
        }

        function updateFiltersForMain() {
            const allGamesData = [];
            for (let profile in data) {
                data[profile].forEach(game => allGamesData.push(game));
            }
            const years = allGamesData.length > 0 ? [...new Set(allGamesData.map(g => g.año))].sort((a, b) => b - a) : [];
            const platforms = allGamesData.length > 0 ? [...new Set(allGamesData.map(g => g.plataforma))].sort() : [];
            const yearSelect = document.getElementById('filterYear');
            yearSelect.innerHTML = '<option value="">Todos</option>' + (years.length > 0 ? years.map(y => `<option value="${y}">${y}</option>`).join('') : '');
            const platformSelect = document.getElementById('filterPlatform');
            platformSelect.innerHTML = '<option value="">Todos</option>' + (platforms.length > 0 ? platforms.map(p => `<option value="${p}">${p}</option>`).join('') : '');
        }

        function applyFiltersAndSearch() {
            const selectedYear = document.getElementById('filterYear').value;
            const selectedPlatform = document.getElementById('filterPlatform').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filteredGames;
            if (currentProfile !== 'main') {
                filteredGames = allGames.filter(game => {
                    return (!selectedYear || game.año == selectedYear) &&
                           (!selectedPlatform || game.plataforma === selectedPlatform) &&
                           (!searchTerm || game.titulo.toLowerCase().includes(searchTerm));
                });
                renderGames(filteredGames);
            } else {
                const allGamesData = [];
                for (let profile in data) {
                    data[profile].forEach(game => allGamesData.push({ ...game, profile }));
                }
                filteredGames = allGamesData.filter(game => {
                    return (!selectedYear || game.año == selectedYear) &&
                           (!selectedPlatform || game.plataforma === selectedPlatform) &&
                           (!searchTerm || game.titulo.toLowerCase().includes(searchTerm));
                });
                renderMainGamesWithFilter('', filteredGames);
            }
        }

        function applySearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (currentProfile !== 'main') {
                const filteredGames = allGames.filter(game =>
                    !searchTerm || game.titulo.toLowerCase().includes(searchTerm)
                );
                renderGames(filteredGames);
            } else {
                renderMainGamesWithFilter(searchTerm);
            }
            applyMustPlaySearch(searchTerm); // Aplicar búsqueda a la lista cronológica
        }

        function applyMustPlaySearch(searchTerm) {
            if (document.getElementById('mustPlayContainer').style.display !== 'none') {
                const sortedGames = [...mustPlayData].sort((a, b) => {
                    const order = document.getElementById('sortOrder').value === 'asc' ? 1 : -1;
                    return order * (a.año - b.año);
                });
                const filteredGames = sortedGames.filter(game =>
                    !searchTerm || game.titulo.toLowerCase().includes(searchTerm)
                );
                renderedMustPlayGames = [];
                renderMustPlayGames(filteredGames);
            }
        }

        function renderGames(games) {
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '';
            games.forEach((game, index) => {
                const allPuntajes = [];
                for (let profile in data) {
                    const foundGame = data[profile].find(g => g.titulo === game.titulo && g.año === game.año && g.plataforma === game.plataforma);
                    if (foundGame) allPuntajes.push({ profile, puntaje: foundGame.puntaje });
                }
                const puntajesText = allPuntajes.map(p => `${p.profile}: ${p.puntaje}`).join('<br>');
                const currentProfilePuntaje = game.puntaje;
                const card = document.createElement('div');
                card.className = 'game-card';
                card.innerHTML = `
                    <img src="${game.img}" alt="${game.titulo}" onerror="this.src='https://via.placeholder.com/200x280/444/fff?text=${game.titulo}'">
                    <h3>${game.titulo}</h3>
                    <p>${game.año} | ${game.plataforma}</p>
                    <p>Puntajes:<br>${puntajesText}</p>
                    <p>Promedio: ${(allPuntajes.length > 0 ? (allPuntajes.reduce((a, b) => a + b.puntaje, 0) / allPuntajes.length).toFixed(2) : game.puntaje)}</p>
                    <p><strong>Puntaje (${currentProfile}): ${currentProfilePuntaje}</strong></p>
                    <button class="edit-btn" onclick="editGame(${index})">Editar</button>
                    <button onclick="deleteGame(${index})">Eliminar</button>
                `;
                container.appendChild(card);
            });
        }

        function renderMainGamesWithFilter(searchTerm = '', filteredGames = null) {
            const allGamesData = filteredGames || [];
            if (!filteredGames) {
                for (let profile in data) {
                    data[profile].forEach(game => allGamesData.push({ ...game, profile }));
                }
            }
            const uniqueGames = {};
            allGamesData.forEach(game => {
                const key = `${game.titulo}-${game.año}-${game.plataforma}`;
                if (!uniqueGames[key]) {
                    uniqueGames[key] = { ...game, puntajes: [], profiles: [] };
                }
                uniqueGames[key].puntajes.push(game.puntaje);
                uniqueGames[key].profiles.push(game.profile);
            });

            const gamesArray = Object.values(uniqueGames).filter(game =>
                !searchTerm || game.titulo.toLowerCase().includes(searchTerm)
            );
            gamesArray.sort((a, b) => {
                const avgA = a.puntajes.reduce((sum, p) => sum + p, 0) / a.puntajes.length;
                const avgB = b.puntajes.reduce((sum, p) => sum + p, 0) / b.puntajes.length;
                return avgB - avgA;
            });

            const container = document.getElementById('mainGamesContainer');
            const start = renderedMainGames.length;
            const end = Math.min(start + PAGE_SIZE, gamesArray.length);
            for (let i = start; i < end; i++) {
                const game = gamesArray[i];
                const puntajesText = game.puntajes.map((p, i) => `${game.profiles[i]}: ${p}`).join('<br>');
                const promedio = game.puntajes.reduce((sum, p) => sum + p, 0) / game.puntajes.length;
                const card = document.createElement('div');
                card.className = 'main-game-card';
                card.innerHTML = `
                    <img src="${game.img}" alt="${game.titulo}" onerror="this.src='https://via.placeholder.com/200x280/444/fff?text=${game.titulo}'">
                    <h3>${game.titulo}</h3>
                    <p>${game.año} | ${game.plataforma}</p>
                    <p>Puntajes:<br>${puntajesText}</p>
                    <p>Promedio: <strong>${promedio.toFixed(2)}</strong></p>
                `;
                container.appendChild(card);
                renderedMainGames.push(game);
            }
            document.getElementById('loadMoreMain').style.display = end < gamesArray.length ? 'block' : 'none';
            document.getElementById('loadAllMain').style.display = end < gamesArray.length ? 'block' : 'none';
        }

        function renderMainGames() {
            renderedMainGames = [];
            const container = document.getElementById('mainGamesContainer');
            container.innerHTML = '';
            renderMainGamesWithFilter('');
        }

        function loadMoreMainGames() {
            renderMainGamesWithFilter('');
        }

        function loadAllMainGames() {
            renderedMainGames = [];
            const allGamesData = [];
            for (let profile in data) {
                data[profile].forEach(game => allGamesData.push({ ...game, profile }));
            }
            const uniqueGames = {};
            allGamesData.forEach(game => {
                const key = `${game.titulo}-${game.año}-${game.plataforma}`;
                if (!uniqueGames[key]) {
                    uniqueGames[key] = { ...game, puntajes: [], profiles: [] };
                }
                uniqueGames[key].puntajes.push(game.puntaje);
                uniqueGames[key].profiles.push(game.profile);
            });
            const gamesArray = Object.values(uniqueGames);
            const container = document.getElementById('mainGamesContainer');
            container.innerHTML = '';
            gamesArray.forEach(game => {
                const puntajesText = game.puntajes.map((p, i) => `${game.profiles[i]}: ${p}`).join('<br>');
                const promedio = game.puntajes.reduce((sum, p) => sum + p, 0) / game.puntajes.length;
                const card = document.createElement('div');
                card.className = 'main-game-card';
                card.innerHTML = `
                    <img src="${game.img}" alt="${game.titulo}" onerror="this.src='https://via.placeholder.com/200x280/444/fff?text=${game.titulo}'">
                    <h3>${game.titulo}</h3>
                    <p>${game.año} | ${game.plataforma}</p>
                    <p>Puntajes:<br>${puntajesText}</p>
                    <p>Promedio: <strong>${promedio.toFixed(2)}</strong></p>
                `;
                container.appendChild(card);
                renderedMainGames.push(game);
            });
            document.getElementById('loadMoreMain').style.display = 'none';
            document.getElementById('loadAllMain').style.display = 'none';
        }

        function toggleForm(formType, index = -1) {
            const addForm = document.getElementById('addForm');
            const editForm = document.getElementById('editForm');
            const mustPlayForm = document.getElementById('mustPlayForm');
            addForm.classList.remove('active');
            editForm.classList.remove('active');
            mustPlayForm.classList.remove('active');
            if (formType === 'add') {
                addForm.classList.add('active');
                addForm.reset();
            } else if (formType === 'edit' && index >= 0) {
                editForm.classList.add('active');
                editIndex = index;
                const game = allGames[index];
                document.getElementById('editGameTitle').value = game.titulo;
                document.getElementById('editGameYear').value = game.año;
                document.getElementById('editGamePlatform').value = game.plataforma;
                document.getElementById('editGamePuntaje').value = game.puntaje;
                document.getElementById('editGameImage').value = game.img;
            } else if (formType === 'must-play') {
                mustPlayForm.classList.add('active');
                mustPlayForm.reset();
            }
        }

        function addGame() {
            const titulo = document.getElementById('gameTitle').value;
            const año = parseInt(document.getElementById('gameYear').value);
            const plataforma = document.getElementById('gamePlatform').value;
            const puntaje = parseFloat(document.getElementById('gamePuntaje').value);
            const img = document.getElementById('gameImage').value;

            if (titulo && año && plataforma && !isNaN(puntaje) && img) {
                if (!data[currentProfile]) data[currentProfile] = [];
                data[currentProfile].push({ titulo, año, plataforma, puntaje, img });
                localStorage.setItem('gameData', JSON.stringify(data));
                updateDisplay();
                toggleForm('add');
            } else {
                alert('Por favor, completa todos los campos correctamente.');
            }
        }

        function editGame(index) {
            toggleForm('edit', index);
        }

        function saveEdit() {
            const titulo = document.getElementById('editGameTitle').value;
            const año = parseInt(document.getElementById('editGameYear').value);
            const plataforma = document.getElementById('editGamePlatform').value;
            const puntaje = parseFloat(document.getElementById('editGamePuntaje').value);
            const img = document.getElementById('editGameImage').value;

            if (titulo && año && plataforma && !isNaN(puntaje) && img && editIndex >= 0) {
                data[currentProfile][editIndex] = { titulo, año, plataforma, puntaje, img };
                localStorage.setItem('gameData', JSON.stringify(data));
                updateDisplay();
                toggleForm('edit');
            } else {
                alert('Por favor, completa todos los campos correctamente.');
            }
        }

        function deleteGame(index) {
            if (confirm('¿Estás seguro de eliminar este juego?')) {
                data[currentProfile].splice(index, 1);
                localStorage.setItem('gameData', JSON.stringify(data));
                updateDisplay();
            }
        }

        function syncToClipboard() {
            const csvContent = [
                ['Perfil', 'Título', 'Año', 'Plataforma', 'Puntaje', 'Imagen'],
                ...Object.entries(data).flatMap(([profile, games]) =>
                    games.map(game => [profile, game.titulo, game.año, game.plataforma, game.puntaje, game.img])
                )
            ].map(row => row.join(',')).join('\n');
            navigator.clipboard.writeText(csvContent).then(() => {
                alert('Datos copiados al portapapeles. Pégalos en Google Sheets (reemplaza la hoja).');
            }).catch(err => {
                alert('Error al copiar: ' + err);
            });
        }

        function loadMustPlay() {
            loadMustPlayData();
            const container = document.getElementById('mustPlayContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            if (container.style.display === 'block') {
                mustPlayOffset = 0;
                renderedMustPlayGames = [];
                applyMustPlayFilters();
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);
            }
        }

        function applyMustPlayFilters() {
            const sortOrder = document.getElementById('sortOrder').value;
            let sortedGames = [...mustPlayData];
            sortedGames.sort((a, b) => sortOrder === 'asc' ? a.año - b.año : b.año - a.año);
            renderMustPlayGames(sortedGames);
        }

        function renderMustPlayGames(games) {
            const container = document.getElementById('mustPlayContainer');
            let html = `
                <div class="must-play-controls">
                    <label>Orden:</label>
                    <select id="sortOrder" onchange="applyMustPlayFilters()">
                        <option value="asc">Más antiguo al más nuevo</option>
                        <option value="desc">Más nuevo al más antiguo</option>
                    </select>
                </div>
                <button class="sync-button" onclick="tryYourLuck()">Proba tu suerte</button>
            `;
            const start = renderedMustPlayGames.length;
            const end = Math.min(start + PAGE_SIZE, games.length);
            if (start === 0 && games.length === 0) {
                html += '<p>No hay juegos Must Play disponibles.</p>';
            } else {
                for (let i = start; i < end; i++) {
                    const game = games[i];
                    html += `
                        <div class="must-play-card">
                            <img src="${game.img}" alt="${game.titulo}" onerror="this.src='https://via.placeholder.com/200x280/444/fff?text=${game.titulo}'">
                            <h3>${game.titulo}</h3>
                            <p>${game.año} | ${game.plataforma}</p>
                            <p>Desarrolladora: ${game.desarrolladora}</p>
                        </div>
                    `;
                    renderedMustPlayGames.push(game);
                }
            }
            container.innerHTML = html;
            document.getElementById('loadMoreMustPlay').style.display = end < games.length ? 'block' : 'none';
            document.getElementById('loadAllMustPlay').style.display = end < games.length ? 'block' : 'none';
        }

        function loadMoreMustPlayGames() {
            applyMustPlayFilters();
        }

        function loadAllMustPlayGames() {
            renderedMustPlayGames = [];
            const container = document.getElementById('mustPlayContainer');
            let html = `
                <div class="must-play-controls">
                    <label>Orden:</label>
                    <select id="sortOrder" onchange="applyMustPlayFilters()">
                        <option value="asc">Más antiguo al más nuevo</option>
                        <option value="desc">Más nuevo al más antiguo</option>
                    </select>
                </div>
                <button class="sync-button" onclick="tryYourLuck()">Proba tu suerte</button>
            `;
            const sortOrder = document.getElementById('sortOrder').value;
            let sortedGames = [...mustPlayData];
            sortedGames.sort((a, b) => sortOrder === 'asc' ? a.año - b.año : b.año - a.año);
            if (sortedGames.length === 0) {
                html += '<p>No hay juegos Must Play disponibles.</p>';
            } else {
                sortedGames.forEach(game => {
                    html += `
                        <div class="must-play-card">
                            <img src="${game.img}" alt="${game.titulo}" onerror="this.src='https://via.placeholder.com/200x280/444/fff?text=${game.titulo}'">
                            <h3>${game.titulo}</h3>
                            <p>${game.año} | ${game.plataforma}</p>
                            <p>Desarrolladora: ${game.desarrolladora}</p>
                        </div>
                    `;
                    renderedMustPlayGames.push(game);
                });
            }
            container.innerHTML = html;
            document.getElementById('loadMoreMustPlay').style.display = 'none';
            document.getElementById('loadAllMustPlay').style.display = 'none';
        }

        function addMustPlayGame() {
            const titulo = document.getElementById('mustPlayTitle').value;
            const año = parseInt(document.getElementById('mustPlayYear').value);
            const desarrolladora = document.getElementById('mustPlayDeveloper').value;
            const plataforma = document.getElementById('mustPlayPlatform').value;
            const img = document.getElementById('mustPlayImage').value;

            if (titulo && año && desarrolladora && plataforma && img) {
                mustPlayData.push({ titulo, año, desarrolladora, plataforma, img });
                localStorage.setItem('mustPlayData', JSON.stringify(mustPlayData));
                toggleForm('must-play');
                mustPlayOffset = 0;
                renderedMustPlayGames = [];
                applyMustPlayFilters();
            } else {
                alert('Por favor, completa todos los campos correctamente.');
            }
        }

        function tryYourLuck() {
            if (mustPlayData.length === 0) {
                alert('No hay juegos Must Play para seleccionar.');
                return;
            }
            const randomGame = mustPlayData[Math.floor(Math.random() * mustPlayData.length)];
            const container = document.getElementById('mustPlayContainer');
            let html = `
                <div class="must-play-controls">
                    <label>Orden:</label>
                    <select id="sortOrder" onchange="applyMustPlayFilters()">
                        <option value="asc">Más antiguo al más nuevo</option>
                        <option value="desc">Más nuevo al más antiguo</option>
                    </select>
                </div>
                <button class="sync-button" onclick="tryYourLuck()">Proba tu suerte</button>
            `;
            html += `
                <div class="must-play-card">
                    <img src="${randomGame.img}" alt="${randomGame.titulo}" onerror="this.src='https://via.placeholder.com/200x280/444/fff?text=${game.titulo}'">
                    <h3>${randomGame.titulo}</h3>
                    <p>${randomGame.año} | ${randomGame.plataforma}</p>
                    <p>Desarrolladora: ${randomGame.desarrolladora}</p>
                    <p><strong>¡Ahora debes jugar este juego!</strong></p>
                </div>
            `;
            container.innerHTML = html;
            renderedMustPlayGames = [randomGame];
            document.getElementById('loadMoreMustPlay').style.display = 'none';
            document.getElementById('loadAllMustPlay').style.display = 'none';
            document.getElementById('mustPlayContainer').scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function toggleDebug() {
            debugEnabled = !debugEnabled;
            document.body.classList.toggle('debug-active', debugEnabled);
            const debugButton = document.querySelector('.debug-toggle');
            debugButton.textContent = debugEnabled ? 'Ocultar Depuración' : 'Mostrar Depuración';
            if (!debugEnabled) {
                document.getElementById('debug').innerHTML = '';
            } else {
                loadData();
            }
        }

        function playAudio() {
            const audio = document.getElementById('audioPlayer');
            audio.play().catch(error => {
                alert('Error al reproducir el audio: ' + error.message);
            });
        }
    </script>
</body>
</html>
